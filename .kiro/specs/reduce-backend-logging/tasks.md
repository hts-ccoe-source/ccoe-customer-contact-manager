# Implementation Plan

- [x] 1. Initialize slog in Lambda handler
  - Add slog initialization at start of Lambda handler in main.go
  - Default to JSON output for Lambda mode (CloudWatch)
  - Default to text output for CLI mode (human-readable)
  - Allow override via LOG_FORMAT environment variable
  - Set as default logger with `slog.SetDefault(logger)`
  - Set default level to Info (Debug only for troubleshooting)
  - _Requirements: 4.2, 4.3_

- [x] 2. Audit and categorize all log statements in main.go
  - Search for all `log.Printf()` calls in main.go Lambda handler
  - Categorize each as: ERROR (keep), WARN (keep selective), INFO (keep critical only), or DELETE
  - Target: Reduce from ~200+ logs to ~20-30 logs
  - Document which logs to keep vs remove
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 2.2, 3.4_

- [x] 3. Migrate logging in main.go Lambda handler to slog
  - Convert ERROR logs: `log.Printf("❌...")` → `logger.Error("...", "error", err)`
  - Convert WARN logs: `log.Printf("⚠️...")` → `logger.Warn("...")`
  - Convert INFO logs: `log.Printf("✅...")` → `logger.Info("...")`
  - DELETE verbose success logs (don't convert to Debug)
  - Remove all emoji characters
  - Add single summary log at end: `logger.Info("lambda complete", "processed", count, "errors", errCount, "duration_ms", ms)`
  - _Requirements: 1.1, 1.2, 2.1, 2.2, 2.3, 2.4, 4.1, 4.2, 4.3_

- [x] 4. Add logger parameter to AnnouncementProcessor
  - Add `logger *slog.Logger` field to AnnouncementProcessor struct
  - Update NewAnnouncementProcessor to accept logger parameter
  - Pass logger through to all processor methods
  - _Requirements: 4.2_

- [x] 5. Migrate logging in internal/processors/announcement_processor.go to slog
  - Audit all log.Printf calls (~100+ logs)
  - DELETE verbose step-by-step processing logs (don't convert)
  - Convert ERROR logs to logger.Error with structured fields
  - Convert meeting scheduled/cancelled to logger.Info (critical operations)
  - Convert email sent to logger.Info with recipient count
  - Target: Reduce from ~100+ logs to ~15-20 logs
  - _Requirements: 1.1, 2.1, 2.2, 3.1, 3.2, 3.3, 4.1, 4.2, 4.3_

- [x] 6. Migrate logging in internal/lambda/handlers.go to slog
  - Add logger parameter to handler functions
  - DELETE verbose SQS message processing logs
  - DELETE successful S3 event parsing logs
  - DELETE customer code extraction success logs
  - Convert ERROR logs to logger.Error
  - Convert WARN logs to logger.Warn
  - Target: Reduce from ~50+ logs to ~5-10 logs
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 4.1, 4.2, 4.3_

- [x] 7. Migrate logging in internal/ses/meetings.go to slog
  - Add logger parameter to meeting functions
  - DELETE verbose meeting creation step logs
  - Convert meeting scheduled to logger.Info with meeting_id
  - Convert meeting cancelled to logger.Info with result
  - Convert ERROR logs to logger.Error
  - Target: Reduce from ~30+ logs to ~5-8 logs
  - _Requirements: 1.1, 2.1, 3.1, 3.2, 4.1, 4.2, 4.3_

- [x] 8. Migrate logging in internal/ses/operations.go to slog
  - Add logger parameter to SES operation functions
  - DELETE verbose SES operation success logs
  - Convert email sent to logger.Info with type and recipient_count
  - Convert ERROR logs to logger.Error
  - Convert WARN logs to logger.Warn
  - Target: Reduce from ~50+ logs to ~10-15 logs
  - _Requirements: 1.1, 2.1, 3.3, 4.1, 4.2, 4.3_

- [x] 7. Review and preserve concurrent logging patterns
  - Review CustomerLogBuffer usage in processCustomer()
  - Review ImportAllAWSContactsWithLogger() buffered logging
  - Remove emoji from buffered log messages
  - Reduce verbosity but keep customer grouping intact
  - Preserve logBuffer.Printf() and logBuffer.Flush() pattern
  - _Requirements: 1.1, 4.1, 4.2, 4.3_

- [x] 8. Search for and clean up logging in any remaining files
  - Use grep to find all log.Printf and slog calls
  - Apply same cleanup rules to any other files
  - Ensure consistency across entire codebase
  - _Requirements: 1.1, 4.1, 4.2, 4.3_

- [x] 9. Design and implement comprehensive summary statistics
  - Created ExecutionSummary struct in internal/lambda/summary.go with comprehensive metrics:
    - Timing: StartTime, EndTime, DurationMs()
    - Message Processing: TotalMessages, SuccessfulMessages, RetryableErrors, NonRetryableErrors, DiscardedEvents
    - Customer Processing: CustomersProcessed (list of customer codes)
    - Email Statistics: EmailsSent, EmailsFiltered, EmailsBeforeFilter, EmailErrors
    - Meeting Statistics: MeetingsScheduled, MeetingsCancelled, MeetingsUpdated, MeetingErrors, TotalAttendees, FilteredAttendees, ManualAttendees, FinalAttendeeCount
    - S3 Operations: S3Downloads, S3Uploads, S3Deletes, S3Errors
    - Change Request Processing: ApprovalRequests, ApprovedChanges, CompletedChanges, CancelledChanges
    - Error Details: ErrorMessages (detailed error messages for troubleshooting)
  - Added context helpers: ContextWithSummary(), SummaryFromContext()
  - Integrated summary tracking into Handler function
  - Added tracking for discarded events and customer codes in ProcessSQSRecord and ProcessS3Event
  - Summary is passed through context for access by all processing functions
  - _Requirements: 1.1, 1.2_

- [x] 10. Add summary logging to Lambda handler
  - Added comprehensive summary logging at end of Handler function
  - Single logger.Info call with all metrics as structured fields:
    - duration_ms, total_messages, successful, retryable_errors, non_retryable_errors, discarded_events
    - customers (list of customer codes processed)
    - emails_sent, emails_filtered, emails_before_filter, email_errors
    - meetings_scheduled, meetings_cancelled, meetings_updated, meeting_errors
    - total_attendees, filtered_attendees, manual_attendees, final_attendee_count
    - s3_downloads, s3_uploads, s3_deletes, s3_errors
    - approval_requests, approved_changes, completed_changes, cancelled_changes
  - Summary provides complete picture of Lambda execution in single log entry
  - _Requirements: 1.1, 1.2_

- [x] 11. Integrate summary tracking into all processing functions
  - Add summary tracking to email functions (internal/ses/operations.go):
    - RecordEmailSent() after successful email send
    - RecordEmailFiltering() when recipients are filtered
    - RecordEmailError() on email errors
  - Add summary tracking to meeting functions (internal/ses/meetings.go):
    - RecordMeetingScheduled() after successful meeting creation
    - RecordMeetingCancelled() after successful cancellation
    - RecordMeetingUpdated() after successful update
    - RecordMeetingAttendeeFiltering() when attendees are filtered
    - RecordMeetingError() on meeting errors
  - Add summary tracking to S3 operations (internal/lambda/s3_update_manager.go):
    - RecordS3Download() after successful download
    - RecordS3Upload() after successful upload
    - RecordS3Delete() after successful deletion
    - RecordS3Error() on S3 errors
  - Add summary tracking to change request processing:
    - RecordApprovalRequest() in SendApprovalRequestEmail
    - RecordApprovedChange() in SendApprovedAnnouncementEmail
    - RecordCompletedChange() in SendChangeCompleteEmail
    - RecordCancelledChange() in meeting cancellation
  - Verify each deleted log statement has corresponding metric update
  - See summary-metrics-mapping.md for complete mapping
  - _Requirements: 1.1, 1.2_

- [x] 12. Verify summary statistics completeness
  - For each deleted log, verify corresponding data in summary (use summary-metrics-mapping.md)
  - Test that summary provides same troubleshooting information as individual logs
  - Create test scenarios and verify summary captures all relevant data:
    - Single message processing
    - Multiple messages with mixed success/failure
    - Email sending with filtering
    - Meeting scheduling with attendee filtering
    - S3 operations (download, upload, delete)
    - Error scenarios (retryable and non-retryable)
  - Document any gaps and add missing metrics to summary
  - Verify summary log is readable and useful for troubleshooting
  - _Requirements: 1.1, 1.2_

- [ ] 13. Test in non-production environment
  - Deploy changes to non-prod Lambda
  - Trigger test workflows:
    - Single change request (approval → approved → complete)
    - Multiple concurrent change requests
    - Meeting scheduling with multiple customers
    - Meeting cancellation
    - Email sending with restricted_recipients filtering
    - Error scenarios (invalid customer, S3 errors, email errors)
    - Backend-generated events (should be discarded)
  - Review CloudWatch logs for each workflow
  - Verify summary statistics match expected values
  - Verify log volume reduced significantly (target: 80%+)
  - Compare old logs vs new logs for same workflow - ensure no information loss
  - _Requirements: All_

- [ ] 14. Validate log quality and completeness
  - Verify all errors are still logged with context
  - Verify warnings are still logged for important conditions
  - Verify critical operations are logged (meetings, emails)
  - Verify no emoji characters remain in logs
  - Verify log volume reduced significantly (80%+ reduction)
  - Verify logs are still useful for troubleshooting
  - Verify concurrent customer logs are still grouped properly (CustomerLogBuffer)
  - Verify summary statistics provide complete picture of execution
  - Verify structured logging fields are consistent and useful
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3, 3.4, 4.1, 4.2, 4.3_

- [x] 15. Document logging standards
  - Update code comments with logging guidelines
  - Document what should/shouldn't be logged (Error/Warn/Info/Debug)
  - Add examples of proper slog format with structured fields
  - Document CustomerLogBuffer pattern and when to use it
  - Document ExecutionSummary structure and what metrics to track
  - Document how to add new metrics to summary
  - Create troubleshooting guide using new log format
  - Document summary-metrics-mapping.md maintenance
  - _Requirements: 4.2, 4.3_

- [ ] 16. Deploy to production
  - Deploy cleaned up logging to production Lambda
  - Monitor CloudWatch logs for 24 hours
  - Verify no critical information lost
  - Measure log volume reduction (target: 80%+)
  - Verify concurrent operations still log correctly
  - Verify summary statistics are accurate and complete
  - Collect feedback from team on log usefulness
  - _Requirements: All_
